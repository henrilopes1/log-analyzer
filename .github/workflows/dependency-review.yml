name: Dependency Review

on:
  pull_request:
    paths:
      - 'requirements*.txt'
      - 'pyproject.toml'
      - 'setup.py'
      - 'setup.cfg'
  schedule:
    # Executa toda segunda-feira às 10:00 UTC
    - cron: '0 10 * * 1'

jobs:
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: moderate
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC
        deny-licenses: GPL-2.0, GPL-3.0

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install safety pip-audit
    
    - name: Run Safety check
      run: |
        safety check --json --output safety-report.json || true
    
    - name: Run pip-audit
      run: |
        pip-audit --format=json --output=pip-audit-report.json || true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      with:
        name: security-audit-reports
        path: |
          safety-report.json
          pip-audit-report.json
    
    - name: Check for vulnerabilities
      run: |
        echo "🔍 Checking for known vulnerabilities..."
        if [ -f safety-report.json ] && [ "$(cat safety-report.json)" != "[]" ]; then
          echo "⚠️ Safety found potential vulnerabilities"
          cat safety-report.json
        else
          echo "✅ No vulnerabilities found by Safety"
        fi
        
        if [ -f pip-audit-report.json ]; then
          if python -c "import json; data=json.load(open('pip-audit-report.json')); exit(len(data.get('vulnerabilities', [])) > 0)"; then
            echo "⚠️ pip-audit found potential vulnerabilities"
            cat pip-audit-report.json
          else
            echo "✅ No vulnerabilities found by pip-audit"
          fi
        fi

  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install pip-tools
      run: |
        python -m pip install --upgrade pip
        pip install pip-tools
    
    - name: Update requirements
      run: |
        # Se houver arquivo requirements.in, usar pip-tools
        if [ -f requirements.in ]; then
          pip-compile --upgrade requirements.in
        fi
        
        if [ -f requirements-dev.in ]; then
          pip-compile --upgrade requirements-dev.in
        fi
        
        # Caso contrário, atualizar manualmente as versões principais
        pip install --upgrade pip
        pip install --upgrade -r requirements.txt --dry-run | grep -i "would install" || echo "No updates available"
    
    - name: Check for changes
      id: changes
      run: |
        if git diff --quiet; then
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "changed=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Create Pull Request
      if: steps.changes.outputs.changed == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: update dependencies"
        title: "📦 Automated dependency updates"
        body: |
          ## 📦 Dependency Updates
          
          This PR contains automated dependency updates.
          
          ### Changes
          - Updated Python package dependencies
          - All tests should pass before merging
          
          ### Security
          - [x] Dependency review completed
          - [x] Security audit passed
          
          **Note**: This PR was created automatically. Please review the changes before merging.
        branch: chore/update-dependencies
        delete-branch: true
        labels: |
          dependencies
          automated
          chore